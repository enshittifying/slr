<script>
  // Client-side Javascript for the Stanford Law Review Workflow Management System

  function getCurrentUserEmail() {
    const el = document.getElementById('userEmailHidden');
    return el ? String(el.textContent || '').trim() : '';
  }

  function loadDashboard() {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data) {
          // Admin panel visibility
          const adminSection = document.getElementById('admin-section');
          const role = (data.member && data.member.role) ? String(data.member.role).toLowerCase() : '';
          const isAdmin = (typeof data.isAdmin === 'boolean') ? data.isAdmin : role.includes('admin');
          adminSection.style.display = isAdmin ? 'block' : 'none';
          var adminBadge = document.getElementById('adminBadge');
          if (adminBadge) adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
          if (isAdmin) {
            loadAdminSnapshot();
          }

          // Populate My Tasks
          const tasksContainer = document.getElementById('tasks-container');
          tasksContainer.innerHTML = '';
          if (data.tasks && data.tasks.length > 0) {
            for (const task of data.tasks) {
              tasksContainer.innerHTML += `<div class="card mt-2">
                <div class="card-body">
                  <h5 class="card-title">${task.title}</h5>
                  <p class="card-text">${task.description}</p>
                  <p class="card-text"><small class="text-muted">Due: ${new Date(task.dueDate).toLocaleDateString()}</small></p>
                  <p class="card-text"><span class="badge badge-primary">${task.status}</span></p>
                </div>
              </div>`;
            }
          } else {
            tasksContainer.innerHTML = '<p>No tasks assigned.</p>';
          }

          // Populate Available Forms
          const formsContainer = document.getElementById('forms-container');
          formsContainer.innerHTML = '';
          if (data.forms && data.forms.length > 0) {
            for (const form of data.forms) {
              formsContainer.innerHTML += `<div class="card mt-2">
                <div class="card-body">
                  <h5 class="card-title">${form.formName}</h5>
                  <a href="${form.googleFormId}" target="_blank" class="btn btn-primary">Open Form</a>
                </div>
              </div>`;
            }
          } else {
            formsContainer.innerHTML = '<p>No available forms.</p>';
          }

          // Populate Attendance Record
          const attendanceContainer = document.getElementById('attendance-container');
          attendanceContainer.innerHTML = '';
          if (data.attendance && data.attendance.length > 0) {
            for (const log of data.attendance) {
              attendanceContainer.innerHTML += `<div class="card mt-2">
                <div class="card-body">
                  <h5 class="card-title">${log.eventName}</h5>
                  <p class="card-text"><small class="text-muted">Date: ${new Date(log.date).toLocaleDateString()}</small></p>
                  <p class="card-text"><span class="badge badge-success">${log.status}</span></p>
                </div>
              </div>`;
            }
          } else {
            attendanceContainer.innerHTML = '<p>No attendance records.</p>';
          }
        }
      })
      .withFailureHandler(function(error) {
        const notificationsContainer = document.getElementById('notifications-container');
        if (notificationsContainer) {
          notificationsContainer.innerHTML = `<div class="alert alert-danger" role="alert">${error.message}</div>`;
        }
      })
      .server_getDashboardData();
  }

  function loadMembersForAdmin(members) {
    const select = document.getElementById('assignee-email');
    if (select) {
      select.innerHTML = '';
      if (members && members.length) {
        members.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.email;
          opt.textContent = m.fullName ? `${m.fullName} <${m.email}>` : m.email;
          select.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No members found';
        select.appendChild(opt);
      }
    }
    // attendance multi-select
    const multi = document.getElementById('event-members');
    if (multi) {
      multi.innerHTML = '';
      (members || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.email;
        opt.textContent = m.fullName ? `${m.fullName} <${m.email}>` : m.email;
        multi.appendChild(opt);
      });
    }
  }

  function wireAdminForm() {
    const form = document.getElementById('create-task-form');
    if (!form) return;
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-desc').value.trim();
      const dueDate = document.getElementById('task-due').value; // yyyy-mm-dd
      const assigneeEmail = document.getElementById('assignee-email').value;
      if (!title || !assigneeEmail) {
        alert('Please provide title and assignee.');
        return;
      }
      google.script.run
        .withSuccessHandler(function(res) {
          const n = document.getElementById('notifications-container');
          if (res && res.ok) {
            n.innerHTML = '<div class="alert alert-success" role="alert">Task created and assigned.</div>';
            loadDashboard();
          } else {
            n.innerHTML = `<div class="alert alert-danger" role="alert">${(res && res.error) || 'Failed to create task'}</div>`;
          }
        })
        .withFailureHandler(function(error) {
          const n = document.getElementById('notifications-container');
          n.innerHTML = `<div class="alert alert-danger" role="alert">${error.message}</div>`;
        })
        .server_createAndAssignTask(title, description, dueDate, assigneeEmail);
    });
  }

  function renderMembersTable(members) {
    const tbody = document.querySelector('#members-table tbody');
    if (!tbody) return;
    const currentUserEmail = getCurrentUserEmail();
    tbody.innerHTML = '';
    (members || []).forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.memberId}</td><td>${m.fullName || ''}</td><td>${m.email || ''}</td><td>${m.role || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary mr-1" data-edit-member="${m.memberId}">Edit</button>
          <button class="btn btn-sm btn-outline-danger" data-del-member="${m.memberId}" data-email="${m.email}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('[data-del-member]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-del-member');
        const email = this.getAttribute('data-email') || '';
        if (email && currentUserEmail && email.trim().toLowerCase() === currentUserEmail.trim().toLowerCase()) {
          alert('You cannot delete your own member record while logged in.');
          return;
        }
        if (!confirm('Are you sure you want to delete this member?')) return;
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .deleteMember(id);
      });
    });
    tbody.querySelectorAll('[data-edit-member]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-edit-member');
        const row = this.closest('tr');
        const currentName = row.children[1].textContent;
        const currentEmail = row.children[2].textContent;
        const currentRole = row.children[3].textContent;
        const fullName = prompt('Full name:', currentName);
        if (fullName === null) return;
        const email = prompt('Email:', currentEmail);
        if (email === null) return;
        const role = prompt('Role:', currentRole);
        if (role === null) return;
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .updateMember(id, { fullName: fullName, email: email, role: role });
      });
    });
  }

  function renderTasksTable(tasks, assignments, members) {
    const tbody = document.querySelector('#tasks-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const memberById = {};
    (members || []).forEach(m => { memberById[m.memberId] = m; });
    const assignsByTask = {};
    (assignments || []).forEach(a => {
      if (!assignsByTask[a.taskId]) assignsByTask[a.taskId] = [];
      assignsByTask[a.taskId].push(a);
    });

    (tasks || []).forEach(t => {
      const assignees = (assignsByTask[t.taskId] || []).map(a => {
        const m = memberById[a.memberId] || {};
        return `${m.fullName || m.email || a.memberId} (${a.status})`;
      }).join(', ');

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.taskId}</td><td>${t.title || ''}</td><td>${t.dueDate ? new Date(t.dueDate).toLocaleDateString() : ''}</td>
        <td>${assignees || '-'}</td>
        <td><select class="form-control form-control-sm" data-assign-email></select>
            <button class="btn btn-sm btn-outline-primary mt-1" data-assign-btn data-task-id="${t.taskId}">Assign</button></td>
        <td>
          <button class="btn btn-sm btn-outline-primary mr-1" data-edit-task="${t.taskId}">Edit</button>
          <button class="btn btn-sm btn-outline-danger" data-del-task="${t.taskId}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
      const sel = tr.querySelector('[data-assign-email]');
      (members || []).forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.email;
        opt.textContent = m.fullName ? `${m.fullName} <${m.email}>` : m.email;
        sel.appendChild(opt);
      });
    });

    tbody.querySelectorAll('[data-assign-btn]').forEach(btn => {
      btn.addEventListener('click', function() {
        const tr = this.closest('tr');
        const email = tr.querySelector('[data-assign-email]').value;
        const taskId = this.getAttribute('data-task-id');
        google.script.run
          .withSuccessHandler(function(res){ if (res && res.ok) { loadAdminSnapshot(); } })
          .server_assignTaskByEmail(taskId, email);
      });
    });

    tbody.querySelectorAll('[data-del-task]').forEach(btn => {
      btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to delete this task?')) return;
        const taskId = this.getAttribute('data-del-task');
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .server_deleteTask(taskId);
      });
    });

    tbody.querySelectorAll('[data-edit-task]').forEach(btn => {
      btn.addEventListener('click', function() {
        const tr = this.closest('tr');
        const taskId = this.getAttribute('data-edit-task');
        const curTitle = tr.children[1].textContent;
        const title = prompt('Task title:', curTitle);
        if (title === null) return;
        const dueInput = prompt('Due date (YYYY-MM-DD):', '');
        if (dueInput === null) return;
        const description = prompt('Description:', '');
        if (description === null) return;
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .updateTask(taskId, { title: title, description: description, dueDate: dueInput, linkedFormId: null });
      });
    });
  }

  function renderAssignmentsTable(assignments, members, tasks) {
    const tbody = document.querySelector('#assignments-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const memberById = {};
    (members || []).forEach(m => { memberById[m.memberId] = m; });
    const taskById = {};
    (tasks || []).forEach(t => { taskById[t.taskId] = t; });

    (assignments || []).forEach(a => {
      const m = memberById[a.memberId] || {};
      const t = taskById[a.taskId] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.assignmentId}</td><td>${t.title || a.taskId}</td><td>${m.fullName || m.email || a.memberId}</td><td>${a.status || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-success mr-1" data-status="Completed" data-assignment-id="${a.assignmentId}">Mark Completed</button>
          <button class="btn btn-sm btn-outline-secondary mr-1" data-status="Pending" data-assignment-id="${a.assignmentId}">Mark Pending</button>
          <button class="btn btn-sm btn-outline-danger" data-del-assignment="${a.assignmentId}">Remove</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('[data-del-assignment]').forEach(btn => {
      btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to remove this assignment?')) return;
        const id = this.getAttribute('data-del-assignment');
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .deleteAssignment(id);
      });
    });

    tbody.querySelectorAll('[data-status]').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-assignment-id');
        const status = this.getAttribute('data-status');
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .server_updateTaskStatus(id, status);
      });
    });
  }

  function renderFormsTable(forms) {
    const tbody = document.querySelector('#forms-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    (forms || []).forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.formDefId}</td><td>${f.formName || ''}</td><td>${f.googleFormId || ''}</td><td>${f.questionTitle || ''}</td><td>${f.itemType || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary mr-1" data-generate-form="${f.formName}">Generate</button>
          <button class="btn btn-sm btn-outline-secondary mr-1" data-update-form="${f.formName}">Update</button>
          <button class="btn btn-sm btn-outline-danger" data-del-formdef="${f.formDefId}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('[data-generate-form]').forEach(btn => {
      btn.addEventListener('click', function() {
        const name = this.getAttribute('data-generate-form');
        google.script.run
          .withSuccessHandler(function(){ loadAdminSnapshot(); })
          .generateFormFromMetadata(name);
      });
    });
    tbody.querySelectorAll('[data-update-form]').forEach(btn => {
      btn.addEventListener('click', function() {
        const name = this.getAttribute('data-update-form');
        google.script.run
          .withSuccessHandler(function(){ loadAdminSnapshot(); })
          .updateFormFromMetadata(name);
      });
    });
    tbody.querySelectorAll('[data-del-formdef]').forEach(btn => {
      btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to delete this form definition?')) return;
        const id = this.getAttribute('data-del-formdef');
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .deleteFormDefinition(id);
      });
    });
  }

  function wireCreateFormDef() {
    const form = document.getElementById('create-formdef-form');
    if (!form) return;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const formName = document.getElementById('formdef-name').value.trim();
      const questionTitle = document.getElementById('formdef-question').value.trim();
      const itemType = document.getElementById('formdef-type').value.trim();
      const options = document.getElementById('formdef-options').value.trim();
      if (!formName || !questionTitle || !itemType) return;
      google.script.run
        .withSuccessHandler(function(id){ if (id) { form.reset(); loadAdminSnapshot(); } })
        .createFormDefinition({ formName: formName, googleFormId: '', itemId: '', questionTitle: questionTitle, itemType: itemType, options: options });
    });
  }

  function renderAttendanceTable(attendanceLogs, members) {
    const tbody = document.querySelector('#attendance-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const memberById = {};
    (members || []).forEach(m => { memberById[m.memberId] = m; });
    (attendanceLogs || []).forEach(log => {
      const m = memberById[log.memberId] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${log.eventName || ''}</td><td>${m.fullName || m.email || log.memberId || ''}</td>
        <td>${log.date ? new Date(log.date).toLocaleString() : ''}</td><td>${log.status || ''}</td>
        <td>
          <select data-att-status class="form-control form-control-sm">
            <option ${log.status==='Pending'?'selected':''}>Pending</option>
            <option ${log.status==='Attended'?'selected':''}>Attended</option>
            <option ${log.status==='Absent'?'selected':''}>Absent</option>
          </select>
          <button class="btn btn-sm btn-outline-primary mt-1" data-save-att>Save</button>
        </td>`;
      tbody.appendChild(tr);
      tr.querySelector('[data-save-att]').addEventListener('click', function(){
        const status = tr.querySelector('[data-att-status]').value;
        const updated = Object.assign({}, log, { status: status });
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .updateAttendanceLog(updated);
      });
    });
  }

  function wireCreateEventForm() {
    const form = document.getElementById('create-event-form');
    if (!form) return;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const title = document.getElementById('event-title').value.trim();
      const start = document.getElementById('event-start').value;
      const end = document.getElementById('event-end').value;
      const memSel = document.getElementById('event-members');
      const emails = Array.from(memSel.options).filter(o => o.selected).map(o => o.value);
      if (!title || !start || !end) return;
      google.script.run
        .withSuccessHandler(function(id){ if (id) { form.reset(); loadAdminSnapshot(); } })
        .createTrackedEvent(title, start, end, emails);
    });
  }

  function renderConfigTable(config) {
    const tbody = document.querySelector('#config-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    (config || []).forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${entry.key}</td><td>${entry.value || ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary mr-1" data-edit-cfg-key="${entry.key}">Edit</button>
          <button class="btn btn-sm btn-outline-danger" data-del-cfg-key="${entry.key}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('[data-edit-cfg-key]').forEach(btn => {
      btn.addEventListener('click', function(){
        const key = this.getAttribute('data-edit-cfg-key');
        const newVal = prompt('New value for ' + key + ':');
        if (newVal === null) return;
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .setSystemConfig(key, newVal);
      });
    });
    tbody.querySelectorAll('[data-del-cfg-key]').forEach(btn => {
      btn.addEventListener('click', function(){
        const key = this.getAttribute('data-del-cfg-key');
        if (!confirm('Are you sure you want to delete config key ' + key + '?')) return;
        google.script.run
          .withSuccessHandler(function(ok){ if (ok) { loadAdminSnapshot(); } })
          .setSystemConfig(key, '');
      });
    });
  }

  function wireCreateConfigForm() {
    const form = document.getElementById('create-config-form');
    if (!form) return;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const key = document.getElementById('cfg-key').value.trim();
      const value = document.getElementById('cfg-value').value.trim();
      if (!key) return;
      google.script.run
        .withSuccessHandler(function(ok){ if (ok) { form.reset(); loadAdminSnapshot(); } })
        .setSystemConfig(key, value);
    });
  }

  function loadAdminSnapshot() {
    google.script.run
      .withSuccessHandler(function(snap){
        if (!snap) return;
        loadMembersForAdmin(snap.members);
        renderMembersTable(snap.members);
        renderTasksTable(snap.tasks, snap.assignments, snap.members);
        renderAssignmentsTable(snap.assignments, snap.members, snap.tasks);
        renderFormsTable(snap.forms);
        renderAttendanceTable(snap.attendanceLogs, snap.members);
        renderConfigTable(snap.systemConfig);
        wireAdminForm();
        wireCreateMemberForm();
        wireCreateFormDef();
        wireCreateEventForm();
        wireCreateConfigForm();
      })
      .withFailureHandler(function(error){
        const n = document.getElementById('notifications-container');
        n.innerHTML = `<div class="alert alert-danger" role="alert">Admin load failed: ${error.message}</div>`;
      })
      .server_getAdminSnapshot();
  }

  window.addEventListener('load', loadDashboard);
</script>
